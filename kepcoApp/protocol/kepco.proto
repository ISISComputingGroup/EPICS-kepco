Terminator = '\r\n';
ReplyTimeout = 2000;

getIDN {
    out "*IDN?";
    #Read no more that 39 chars (EPICS limit)
    in "%/(.{0,39})/";
    ExtraInput = Ignore;
}

RST
{
    out "*RST";
}

resetWait {
    out "*RST";
    wait 100;
    writeCurrent "%(\$1CURRENT:SP.VAL)";
    writeVoltage "%(\$1VOLTAGE:SP.VAL)";
    setOutputMode "%(\$1OUTPUTMODE:SP.VAL)";
    setOutputStatus "%(\$1OUTPUTSTATUS:SP.VAL)";
}

setRemote
{
    #Needs to be done first
    out "SYST:REM %{0|1}";
}

getRemote
{
    out "SYST:REM?";
    in "%{0|1}";
}

readActualCurrent {
    out "MEAS:CURR?";
    in "%f";
    ExtraInput = Ignore;
}

readSetpointCurrent {
    out "CURR?";
    in "%f";
    ExtraInput = Ignore;
}

writeCurrent 
{
    # Set into remote mode in order to communicate current
    out "SYST:REM 1";

    # Communicate current
    out "CURR %f";
    
    # immediately update SP:RBV
    out "CURR?";
    in "%(\$1CURRENT:SP:RBV)f";
    ExtraInput = Ignore;
}

readActualVoltage {
    out "MEAS:VOLT?";
    in "%f";
    ExtraInput = Ignore;
}

readSetpointVoltage {
    out "VOLT?";
    in "%f";
    ExtraInput = Ignore;
}

writeVoltage
{
    # Set into remote mode in order to communicate voltage
    out "SYST:REM 1";

    # Communicate voltage
    out "VOLT %f";
    
    # immediately update SP:RBV
    out "VOLT?";
    in "%(\$1VOLTAGE:SP:RBV)f";
    ExtraInput = Ignore;
}

readOutputMode
{
    out "FUNC:MODE?";
    in "%d";
    ExtraInput = Ignore;
}

setOutputMode
{
    # Set into remote mode in order to communicate output mode
    out "SYST:REM 1";

    # Communicate output mode
    out "FUNC:MODE %{VOLT|CURR}";
    
    # Immediately update readback
    out "FUNC:MODE?";
    in "%(\$1OUTPUTMODE)d";
    ExtraInput = Ignore;
}

readOutputStatus
{
    out "OUTP?";
    in "%d";
    ExtraInput = Ignore;
}

setOutputStatus
{
    # Set into remote mode in order to communicate output status
    out "SYST:REM 1";

    # Communicate output status
    out "OUTP %{0|1}";
    
    # Immediately update readback
    out "OUTP?";
    in "%(\$1OUTPUTSTATUS)d";
    ExtraInput = Ignore;
}
